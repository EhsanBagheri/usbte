
<!DOCTYPE html>
<html>
<!-- SCOPE -->
<!-- See: https://wicg.github.io/webusb/ -->
<!-- See: https://wicg.github.io/serial/ -->

<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
<title>SCOPE</title>
    <style>
pre { white-space: pre-wrap; word-wrap: break-word; }
a { text-decoration: none; }
#results { line-height: 1.2; }
#copyright { font-size:65%; padding: 0px; }
* { overflow-wrap: anywhere; word-wrap: anywhere; }
button { overflow-wrap: normal; word-wrap: normal; }
html,button,input { font: 36px Arial, Helvetica, sans-serif; padding: 15px 10px 15px 10px; margin: 15px 0px 15px 0px; }
@media(min-width:80em){ html,button,input { font: 24px Arial, Helvetica, sans-serif; padding: 10px; margin: 10px 0px 10px 0px; } }
@supports(-webkit-touch-callout:none) { button,input { -webkit-appearance: none; border-radius: 2px; } }
body,html { margin: 0px; }
#canvas { outline: red 1px solid; padding: 1px; }
    </style>
</head>

<body onload='Body()'>

<h1>Web SCOPE</h1>

<div id="config">
Select:
<button type='button' onclick="Comm();">Windows</button>
<button type='button' onclick="Usb();">Linux</button>
</div>

sample usec:
<select id="usec">
<option>1</option>
<option>3</option>
<option selected>10</option>
<option>30</option>
<option>100</option>
<option>300</option>
<option>1000</option>
</select>

--

<input type="radio" name="trigger" value="+">rise</input>
<input type="radio" name="trigger" value="" checked>level</input>
<input type="radio" name="trigger" value="-">fall</input>

--

slew %:
<select id="slew">
<option value="0">0</option>
<option selected value="13">5</option>
<option value="26">10</option>
<option value="51">20</option>
<option value="77">30</option>
<option value="102">40</option>
</select>

--

voltage:
<select id="voltage">
<option value="3.3">3.3</option>
</select>

<br>

<canvas id="canvas" width="1040" height="256"></canvas>

<pre id='command'></pre>
<pre id='results'></pre>

<p id='copyright'>
<a href=https://github.com/rtestardi/usbte target=_blank>github.com/rtestardi/usbte</a>
&nbsp;&nbsp;&nbsp;
<a href=https://github.com/rtestardi/StickOS target=_blank>github.com/rtestardi/StickOS</a>
&nbsp;&nbsp;&nbsp;
<a href=https://rtestardi.github.io/StickOS target=_blank>rtestardi.github.io/StickOS</a>

<script>

var usb;
var comm;
var reader;
var writer;
var enc = new TextEncoder();
var dec = new TextDecoder();
var canvas;
var ctx;
var discard;
var string;
var analogV = 512;
var analogY = 128;

// the user loaded the webpage; set up keyboard listeners
function Body()
{
    canvas = document.getElementById('canvas');
    canvas.addEventListener('mousedown', function(e) {
        getCursorPosition(canvas, e)
    })
    ctx = canvas.getContext('2d');
}

function getCursorPosition(canvas, event) {
    const rect = canvas.getBoundingClientRect()
    analogY = event.clientY - rect.top;
    if (analogY > 255) {
       analogY = 255;
    }
    if (analogY < 0) {
        analogY = 0;
    }
    analogV = Math.floor((255-analogY)*1024/256);
}

// the user wants to connect to a USB device's bulk endpoints directly
async function Usb()
{
    var filter = {};
    filter["vendorId"] = 0x0403;
    filter["productId"] = 0xA660;

    try {
        usb = await navigator.usb.requestDevice({ filters: [filter] });
        await usb.open();
        await usb.selectConfiguration(1);
        await usb.claimInterface(1);

        document.getElementById("results").innerHTML = "";
        document.getElementById("config").hidden = true;

        discard = 1;
        setTimeout(Receive, 2);

        Send("echo off\n");
        Send("prompt off\n");

        setTimeout(Scope, 500);
    } catch(err) {
        document.getElementById("results").innerHTML = err.message.replace(/</g,'&lt;').replace(/>/g,'&gt;') + "\r";
    }
}

// the user wants to connect to an emulated COM port
async function Comm()
{
    var filter = {};
    filter["usbVendorId"] = 0x0403;
    filter["usbProductId"] = 0xA660;

    if ('serial' in navigator) {
        try {
            comm = await navigator.serial.requestPort({ filters: [filter] });
            await comm.open({ baudRate: 115200, bufferSize: 64 });
            reader = comm.readable.getReader();
            writer = comm.writable.getWriter();

            document.getElementById("results").innerHTML = "";
            document.getElementById("config").hidden = true;

            discard = 1;
            setTimeout(Receive, 2);

            Send("echo off\n");
            Send("prompt off\n");

            setTimeout(Scope, 500);
        } catch(err) {
            document.getElementById("results").innerHTML = err.message.replace(/</g,'&lt;').replace(/>/g,'&gt;') + "\r";
        }
    } else {
        document.getElementById("results").innerHTML =
`The Web serial API needs to be enabled in your browser thru:
   - <a href=edge://flags/#enable-experimental-web-platform-features>edge://flags/#enable-experimental-web-platform-features</a>
   - <a href=chrome://flags/#enable-experimental-web-platform-features>chrome://flags/#enable-experimental-web-platform-features</a>
   - <a href=opera://flags/#enable-experimental-web-platform-features>opera://flags/#enable-experimental-web-platform-features</a>
`;
    }
}

async function Scope()
{
    discard = 0;
    string = "";
    var command = "scope " + document.getElementById("usec").value + " " + document.querySelector('input[name="trigger"]:checked').value + analogV + " " + document.getElementById("slew").value;
    document.getElementById("command").innerHTML = command;
    Send(command + "\n");
}

// receive a string from the device
async function Receive()
{
    var str;
    var delay;
    var result;

    if (usb) {
        result = await usb.transferIn(2, 64);
        str = dec.decode(result.data.buffer);
    } else {
        result = await reader.read();
        str = dec.decode(result.value);
    }
    if (! discard) {
        string += str.replace(/</g,'&lt;').replace(/>/g,'&gt;');
        if (string.match(/done/)) {
            var lines = string.split(/\r?\n/);

            ctx.clearRect(0, 0, 1040, 256);

            ctx.fillText("3.3V", 1006, 8);
            ctx.fillText(document.getElementById("usec").value + "ms", 1004, 128);
            ctx.fillText("0V", 1006, 255);

            for (var i = 1; i <= 10; i++) {
                if (i == 10) {
                    ctx.strokeStyle = '#ff0000';
                    ctx.setLineDash([])
                } else if (i == 5) {
                    ctx.setLineDash([4,10])
                } else {
                    ctx.setLineDash([2,10])
                }
                ctx.beginPath();
                ctx.moveTo(100*i, 0);
                ctx.lineTo(100*i, 255);
                ctx.stroke();
                ctx.closePath();
                ctx.setLineDash([])
                ctx.strokeStyle = '#000000';
            }

            ctx.setLineDash([8,10])
            ctx.beginPath();
            ctx.moveTo(0, analogY);
            ctx.lineTo(1000, analogY);
            ctx.stroke();
            ctx.closePath();
            ctx.setLineDash([])

            if (lines.length < 10) {
                document.getElementById("command").innerHTML += " no trigger";
                delay = 200;
            } else {
                ctx.beginPath();
                ctx.moveTo(0, 255);
                for (var i = 0; i < 1000 && i < lines.length; i++) {
                    var words = lines[i].split(/ /);
                    ctx.lineTo(i, 255-parseInt(words[0])/4);
                }
                ctx.moveTo(1023, 255);
                ctx.stroke();
                ctx.closePath();
                document.getElementById("command").innerHTML = " ";
                delay=100;
            }
            setTimeout(Scope, delay);
        }
    }
    setTimeout(Receive, 2);
}

// send a string to the device
async function Send(str)
{
    if (usb) {
        await usb.transferOut(3, enc.encode(str).buffer);
    } else {
        await writer.write(enc.encode(str).buffer);
    }
}

</script>
</body>
</html>
