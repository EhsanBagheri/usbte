<!DOCTYPE html>
<html>
<!-- USBTE -->
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
<title>USBTE</title>
</head>

<body onload='Body()'>

<h1>USBTE</h1>
<!-- bulk endpoint from device -->
epin: <input id='epin' name='epin' size='4' value='2'/>

<!-- bulk endpoint to device -->
epout: <input id='epout' name='epout' size='4' value='3'/>

<!-- CpuStick with cdc/acm class/subclass 02/02 replaced with FF/00 -->
vendorId: <input id='vendorId' name='vendorId' size='6' value='0x0403'/>
productId: <input id='productId' name='productId' size='6' value='0xa660'/>

<button type='button' onclick="Connect();">Connect</button>
<h2>results</h2>
<pre id='results'></pre>
<input id='command' name='command' size='80' disabled='true'/>
<p>
<a href=https://github.com/rtestardi/usbte target=_blank>https://github.com/rtestardi/usbte</a>

<script>

var device;
var enc = new TextEncoder();
var dec = new TextDecoder();

function Body()
{
    document.body.addEventListener("keyup", function(event) {
        if (event.keyCode === 67 && event.ctrlKey && document.activeElement === document.getElementById("command")) {
            // ctrl-c in command line -- stop the program
            event.preventDefault();
            Enter("\003");
        }
        if (event.keyCode === 13) {
            // enter -- run the command line
            event.preventDefault();
            Enter(document.getElementById("command").value + "\r");
        }
    })
}

async function Connect()
{
    var filter = {};
    if (document.getElementById("vendorId").value != "") {
      filter["vendorId"] = document.getElementById("vendorId").value;
    }
    if (document.getElementById("productId").value != "") {
      filter["productId"] = document.getElementById("productId").value;
    }

    try {
        device = await navigator.usb.requestDevice({filters: [filter]});
        await device.open();
        await device.selectConfiguration(1);
        await device.claimInterface(1);
        setTimeout(Poll, 100);
        document.getElementById("command").disabled = false;
        document.getElementById("command").focus();
    } catch(err) {
        document.getElementById("results").innerHTML += err.message;
    }
}

async function Poll()
{
    let inresult = await device.transferIn(document.getElementById("epin").value, 64);
    document.getElementById("results").innerHTML += dec.decode(inresult.data.buffer).replace(/</g,'&lt;').replace(/>/g,'&gt;');
    setTimeout(Poll, 100);
}

async function Enter(str)
{
    await device.transferOut(document.getElementById("epout").value, enc.encode(str).buffer);
    document.getElementById("command").value = "";
    document.getElementById("command").focus();
}

</script>
</body>
</html>
